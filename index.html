<!DOCTYPE html>
<html lang="en" style="width:100%;height:100%;margin:0;padding:0;">
<head>
    <meta charset="UTF-8">
    <title>Bubble Treemaps for Uncertainty Visualization - Jochen GÃ¶rtler (@grtlr)</title>
    <script type='text/javascript' src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type='text/javascript' src="https://d3js.org/d3.v4.js"></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/planck/0.1/planck.js"></script>
    <script type='text/javascript' src="./build/d3-bubbletreemap.js"></script>
    <script>
        let working = false;
        var rootTitle = 'skin-UBERON:0002097';
        const LEAF_SIZE = 6;
        const ARC_WIDTH = 3;
        
        function doIt() {
          d3.csv('./html/AS-CT-Tree-Combined.csv', (rootData) => {
            if (!working) {
              working = true;

              const jsonData = buildTree(rootData);
              if (jsonData) {
                let svg = d3.select("#svgCircles");
                svg.selectAll("*").remove();

                let padding = Number(document.getElementById("paddingSlider").value);
                let curvature = Number(document.getElementById("curvatureSlider").value);

                drawChart(jsonData, svg, padding, (curvature === 100 ? 100000 : curvature));
              }
              working = false;
            }
          });
        }

        function buildTree(rootData) {
          const treeMap = new Map();
          const labels = new Set();
          rootData.forEach(data => {
            if (!data['FROM'] || !data['TO']) return;
            labels.add(data['FROM'].trim());
            labels.add(data['TO'].trim());
          });
          for (const label of labels) {
            treeMap.set(label, {
              name: label,
              children: new Set(),
              size: LEAF_SIZE,
              uncertainty: ARC_WIDTH
            });
          }
          for (const data of rootData) {
            if (!data['FROM'] || !data['TO']) continue;
            const from = data['FROM'].trim(), to = data['TO'].trim();
            if (from === to) continue;
            const fromData = treeMap.get(from);
            const toData = treeMap.get(to)
            if (!fromData.children.has(toData)) {
              fromData.children.add(toData);
            }
          }
          const root = treeMap.get(rootTitle);
          countLeaves(root, new Set());
          return root;
        }

        function countLeaves(node, leaves) {
          if (node.children.size === 0) {
            leaves.add(node);
            return;
          }
          for (const child of node.children) {
            const childLeaves = new Set();
            countLeaves(child, childLeaves);
            childLeaves.forEach(l => leaves.add(l));
          }
          node.children = Array.from(node.children);
          node.size = leaves.size;
        }

        function onSelect(selectEl) {
          selectEl.disabled = true;
          rootTitle = selectEl.value;
          doIt();
          selectEl.disabled = false;
        }

        function drawChart(data, svg, padding, curvature) {
            // Create hierarchy.
            let root = d3.hierarchy(data)
                .sum(function(d) { return d.size })
                .sort(function(a, b) { return b.value - a.value; });

            let renderedSVGSize = svg.node().getBoundingClientRect();

            // Create bubbletreemap.
            let bubbletreemap = d3.bubbletreemap()
                .padding(padding)
                .curvature(curvature)
                .hierarchyRoot(root)
                .width(renderedSVGSize.width)
                .height(renderedSVGSize.height)
                .colormap(["#8dd3c7", "#ffffb3", "#bebada", "#fb8072", "#80b1d3", "#fdb462", "#b3de69", "#fccde5", "#d9d9d9", "#bc80bd", "#ccebc5", "#ffed6f"]); // Color brewer: 12-class Paired

            // Do layout and coloring.
            let hierarchyRoot = bubbletreemap.doLayout().doColoring().hierarchyRoot();

            let leafNodes = hierarchyRoot.descendants().filter(function (candidate) {
                return !candidate.children;
            });

            // Draw contour.
            let contourGroup = svg.append("g")
                .attr("class", "contour");

            contourGroup.selectAll("path")
                .data(bubbletreemap.getContour())
                .enter().append("path")
                .attr("d", function(arc) { return arc.d; })
                .style("stroke", "black")
                .style("stroke-width", function(arc) { return arc.strokeWidth; })
                .attr("transform", function(arc) {return arc.transform;});

            // Draw circles.
            let circleGroup = svg.append("g")
                .attr("class", "circlesAfterPlanck");

            circleGroup.selectAll("circle")
                .data(leafNodes)
                .enter().append("circle")
                .attr("r", function(d) { return d.r; })
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .style("fill", function(d) { return d.color; })
                .style("stroke", "black")
                .style("stroke-width", "2");
        }
    </script>
</head>
<body onload="doIt()">
    <select name="organs" onchange="onSelect(this)">
      <option value="Blood-UBERON:0000178">Blood</option>
      <option value="Bone marrow-UBERON:0002371">Bone Marrow</option>
      <option value="brain-UBERON:0000955">Brain</option>
      <option value="heart-UBERON:0000948">Heart</option>
      <option value="kidney-UBERON:0002113">Kidney</option>
      <option value="large intestine-UBERON:0000059">Large Intestine</option>
      <option value="lymph node-UBERON:0000029">Lymph Node</option>
      <option value="Respiratory System-UBERON:0001004">Respiratory System</option>
      <option value="spleen-UBERON:0002106">Spleen</option>
      <option value="skin-UBERON:0002097" selected="selected">Skin</option>
      <option value="thoracic thymus-UBERON:0002370">Thoracic</option>
      <option value="Trachea">Trachea</option>
      <option value="vasculature-UBERON:0002049">Vasculature</option>
    </select>
    <div id="svgCirclesContainer" style="width: 1000px; height: 800px; margin:auto">
        <svg id="svgCircles" width="100%" height="100%"></svg>
    </div>

    <div style="position: absolute; left:20px; top:40px;" id="paddingSliderContainer">
        Padding: <input style="background:grey;position: absolute; left:100px" type="range" min="0" max="100" value="10" class="slider" id="paddingSlider" onchange="doIt()">
    </div>
    <div style="position: absolute; left:20px; top:80px;" id="curvatureSliderContainer">
        Smoothness: <input style="background:grey;position: absolute; left:100px" type="range" min="1" max="100" value="10" class="slider" id="curvatureSlider" onchange="doIt()">
    </div>
</body>
</html>
